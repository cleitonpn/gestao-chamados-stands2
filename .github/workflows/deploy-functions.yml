name: Deploy Firebase Functions

on:
  push:
    branches: [ "main" ]
    paths:
      - "functions/**"
      - ".github/workflows/deploy-functions.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Post Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Firebase CLI
        run: npm i -g firebase-tools

      # Seta as config (sem --force) â€“ usa os seus Secrets
     - name: Set functions:config (VAPID)
  run: |
    firebase functions:config:set \
      messaging.vapid_subject="${{ secrets.VAPID_SUBJECT }}" \
      messaging.vapid_public_key="${{ secrets.VAPID_PUBLIC }}" \
      messaging.vapid_private_key="${{ secrets.VAPID_PRIVATE }}" \
      --project "${{ secrets.FIREBASE_PROJECT_ID }}"

        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

      # Instala dentro de functions/
      - name: Install functions deps (lock novo)
        working-directory: functions
        run: |
          npm i --package-lock-only
          npm i --no-audit --no-fund --legacy-peer-deps

      - name: Deploy Functions
        run: |
          firebase deploy --only functions --project ${{ secrets.FIREBASE_PROJECT_ID }} --token ${{ secrets.FIREBASE_TOKEN }}
