name: Deploy Firebase Functions

on:
  push:
    paths:
      - "functions/**"
      - ".github/workflows/deploy-functions.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Install Firebase CLI
        run: npm i -g firebase-tools

      - name: Install functions deps
        run: |
          cd functions
          npm ci

      # >>> CONFIGS DAS FUNCTIONS (idempotente; roda em todo deploy)
      - name: Set functions:config (messaging)
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          PROJECT_ID:     ${{ secrets.FIREBASE_PROJECT_ID }} # ex.: gestao-chamados-stands
          FCM_SERVER_KEY: ${{ secrets.FCM_SERVER_KEY }}
          VAPID_PUBLIC:   ${{ secrets.VAPID_PUBLIC_KEY }}
          VAPID_PRIVATE:  ${{ secrets.VAPID_PRIVATE_KEY }}
          VAPID_SUBJECT:  ${{ secrets.VAPID_SUBJECT }}
        run: |
          firebase functions:config:set \
            messaging.fcm_server_key="$FCM_SERVER_KEY" \
            messaging.vapid_public_key="$VAPID_PUBLIC" \
            messaging.vapid_private_key="$VAPID_PRIVATE" \
            messaging.vapid_subject="$VAPID_SUBJECT" \
            --project "$PROJECT_ID" --token "$FIREBASE_TOKEN"

      - name: Deploy only Functions
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          PROJECT_ID:     ${{ secrets.FIREBASE_PROJECT_ID }}
        run: |
          firebase deploy --only functions --project "$PROJECT_ID" --token "$FIREBASE_TOKEN"
